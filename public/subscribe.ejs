<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Newsletter Profissional - Not√≠cias Selecionadas</title>
  <style>
    body { font-family: 'Helvetica', Arial, sans-serif; max-width: 900px; margin: 40px auto; background-color: #f9f9f9; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 20px; }
    h2 { color: #34495e; margin: 20px 0; }
    p { color: #7f8c8d; font-size: 1.1em; margin-bottom: 15px; }
    form { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    select, input[type="date"], button { padding: 10px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 1em; }
    button { background-color: #3498db; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #2980b9; }
    .whatsapp-btn { background-color: #25D366; }
    .whatsapp-btn:hover { background-color: #128C7E; }
    ul { list-style: none; padding: 0; }
    li { margin: 15px 0; padding: 15px; border: 2px solid #ecf0f1; border-radius: 8px; background: #fff; }
    a { color: #3498db; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .action-buttons { display: flex; gap: 10px; margin-top: 20px; }
    /* Adicionado para mostrar a imagem de pr√©-visualiza√ß√£o */
    .article-image {
        max-width: 100px;
        max-height: 100px;
        float: left;
        margin-right: 15px;
        border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Newsletter - Not√≠cias Selecionadas</h1>
  <p>Aqui est√£o as not√≠cias dos t√≥picos que voc√™ escolheu.</p>

  <h2>Filtros</h2>
  <form action="/subscribe" method="GET" style="align-items: flex-end;">
    <select name="topic" style="flex: 2;">
      <option value="">Todos os T√≥picos</option>
      <% topics.forEach(t => { %>
        <option value="<%= t %>" <%= (query.topic === t) ? 'selected' : '' %>><%= t %></option>
      <% }); %>
    </select>
    <input type="date" name="startDate" value="<%= query.startDate || '' %>" placeholder="Data Inicial" style="flex: 2;">
    <input type="date" name="endDate" value="<%= query.endDate || '' %>" placeholder="Data Final" style="flex: 2;">
    <button type="submit" style="flex: 1;">Filtrar</button>
  </form>

  <h2>Not√≠cias</h2>
  <% if (articles && articles.length > 0) { %>
    <form id="newsForm" action="/send-email" method="POST">
      <ul>
        <% articles.forEach(a => { %>
          <%# ALTERA√á√ÉO: Adicionados data-source e data-image %>
          <li data-title="<%= a.title %>" 
              data-link="<%= a.link %>" 
              data-topic="<%= a.topic %>"
              data-source="<%= a.source %>"
              data-image="<%= a.image || '' %>">

            <% if (a.image) { %>
              <img src="<%= a.image %>" alt="Imagem da mat√©ria" class="article-image">
            <% } %>
            <input type="checkbox" name="selectedArticles" value="<%= a.link %>">
            <strong><%= a.title %></strong><br>
            <%= a.description || 'Sem descri√ß√£o' %><br>
            <em>Fonte:</em> <%= a.source %><br>
            <em>Data:</em> <%= new Date(a.pubDate).toLocaleString('pt-BR') %><br>
            <a href="<%= a.link %>" target="_blank">Leia mais</a>
          </li>
        <% }); %>
      </ul>
      <div class="action-buttons">
        <button type="submit" style="flex: 1;">Enviar Selecionadas por E-mail</button>
        <button type="button" onclick="copyToWhatsapp()" class="whatsapp-btn" style="flex: 1;">Copiar para envio de Whatsapp</button>
      </div>
    </form>
  <% } else { %>
    <p>Nenhuma not√≠cia dispon√≠vel.</p>
  <% } %>
  <p>Atualizado por: Sistema Newsletter Pro - <%= new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }) %></p>
  <p><a href="/">Voltar para Gerenciar Inscri√ß√µes</a></p>

  <script>
    function copyToWhatsapp() {
      const form = document.getElementById('newsForm');
      const checkedBoxes = form.querySelectorAll('input[name="selectedArticles"]:checked');

      if (checkedBoxes.length === 0) {
        alert('Por favor, selecione ao menos uma not√≠cia para copiar.');
        return;
      }

      let whatsappText = 'üì∞ *Resumo de Not√≠cias Selecionadas*\n\n';
      whatsappText += '-----------------------------------\n\n';

      checkedBoxes.forEach(checkbox => {
        const listItem = checkbox.closest('li');
        // ** ALTERA√á√ÉO: Captura de todos os dados **
        const title = listItem.dataset.title;
        const topic = listItem.dataset.topic;
        const source = listItem.dataset.source;
        const link = listItem.dataset.link;
        const image = listItem.dataset.image;
        
        // ** ALTERA√á√ÉO: Novo formato profissional para o WhatsApp **
        whatsappText += `*${title.trim()}*\n\n`;
        whatsappText += `*Assuntos:* ${topic}\n`;
        whatsappText += `*Fonte:* ${source}\n\n`;
        if (image) {
            whatsappText += `*Imagem:* ${image}\n\n`;
        }
        whatsappText += `*Leia mais:* ${link}\n\n`;
        whatsappText += '-----------------------------------\n\n';
      });
      
      navigator.clipboard.writeText(whatsappText.trim())
        .then(() => {
          alert(`Not√≠cias copiadas para a √°rea de transfer√™ncia! O texto formatado est√° pronto para colar no WhatsApp.`);
        })
        .catch(err => {
          console.error('Falha ao copiar texto: ', err);
          alert('Ocorreu um erro ao tentar copiar as not√≠cias.');
        });
    }
  </script>
</body>
</html>